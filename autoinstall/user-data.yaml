#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us

  identity:
    hostname: lerix-node
    username: lerix
    password: "$6$tSX3J8Oo4ZILqRCW$OS8ZR2.AZDi/AkbNmkc3VvJ0oith1zZ7eHetPR8oukUNtCdFpFi9814Kl2VJrZB5bUzwbKZedfrikDYhl1CAX0"

  ssh:
    install-server: true
    allow-pw: true

  packages:
    - docker.io
    - pciutils
    - ubuntu-drivers-common

  storage:
    layout:
      name: direct

  late-commands:
    - curtin in-target -- bash -lc 'set -eux; systemctl enable docker.service containerd.service; systemctl restart docker.service'
    - curtin in-target -- bash -lc 'set -eux; if lspci | grep -qi nvidia; then ubuntu-drivers install; fi'
    - |
      cat > /target/etc/profile.d/90-gpu-docker-info.sh <<'SCRIPT'
      #!/usr/bin/env bash
      [ -t 1 ] || return 0

      if command -v nvidia-smi >/dev/null 2>&1 && nvidia-smi -L >/dev/null 2>&1; then
        gpu_msg="NVIDIA GPU detected"
      else
        gpu_msg="NVIDIA GPU not detected"
      fi

      if systemctl is-active --quiet docker; then
        docker_msg="Docker service: active"
      else
        docker_msg="Docker service: inactive"
      fi

      printf '\n[INFO] %s | %s\n\n' "$gpu_msg" "$docker_msg"
      SCRIPT
    - chmod 0755 /target/etc/profile.d/90-gpu-docker-info.sh

  shutdown: reboot
